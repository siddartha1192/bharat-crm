# =============================================================================
# BHARAT CRM - WORKER SUPERVISOR CONFIGURATION
# =============================================================================
#
# This configuration runs two processes:
#   1. Qdrant vector database
#   2. Node.js worker (background jobs)
#
# =============================================================================

[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor
user=root

# =============================================================================
# QDRANT VECTOR DATABASE
# =============================================================================
[program:qdrant]
command=/usr/local/bin/qdrant --config-path /qdrant/config/config.yaml
directory=/qdrant
autostart=true
autorestart=true
startsecs=10
startretries=3
stopwaitsecs=30
stdout_logfile=/var/log/supervisor/qdrant.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=3
stderr_logfile=/var/log/supervisor/qdrant-error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=3
environment=QDRANT__SERVICE__HOST="0.0.0.0",QDRANT__SERVICE__HTTP_PORT="6333",QDRANT__SERVICE__GRPC_PORT="6334",QDRANT__STORAGE__STORAGE_PATH="/qdrant/storage"
priority=100

# =============================================================================
# NODE.JS WORKER
# =============================================================================
[program:worker]
command=node worker.js
directory=/app
autostart=true
autorestart=true
startsecs=15
startretries=3
stopwaitsecs=30
stdout_logfile=/var/log/supervisor/worker.log
stdout_logfile_maxbytes=20MB
stdout_logfile_backups=5
stderr_logfile=/var/log/supervisor/worker-error.log
stderr_logfile_maxbytes=20MB
stderr_logfile_backups=5
user=nodejs
priority=200

# Wait for Qdrant to be ready before starting worker
depends_on=qdrant

# =============================================================================
# PROCESS GROUPS
# =============================================================================
[group:crm-worker]
programs=qdrant,worker
priority=999

# =============================================================================
# EVENT LISTENERS
# =============================================================================
[eventlistener:process_exit]
command=/bin/bash -c 'echo "Process exited" >> /var/log/supervisor/events.log'
events=PROCESS_STATE_EXITED
