// This is your Prisma schema file
// Learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  MANAGER
  AGENT
  VIEWER
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  TRIAL
  CANCELLED
}

enum SubscriptionPlan {
  FREE
  BASIC
  PROFESSIONAL
  ENTERPRISE
}

enum StageType {
  LEAD
  DEAL
  BOTH
}

// Tenant Model - Multi-tenant organization/company
model Tenant {
  id     String  @id @default(uuid())
  name   String // Company/Organization name
  slug   String  @unique // URL-friendly identifier
  domain String? @unique // Custom domain (optional)

  // Subscription & billing
  status            TenantStatus     @default(TRIAL)
  plan              SubscriptionPlan @default(FREE)
  subscriptionStart DateTime?
  subscriptionEnd   DateTime?
  maxUsers          Int              @default(5)

  // Settings
  settings Json? // Tenant-specific settings (branding, features, etc.)

  // Contact information
  contactEmail String
  contactPhone String?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users       User[]
  invitations TenantInvitation[]

  @@index([slug])
  @@index([status])
}

// Tenant Invitation Model - Invite users to join a tenant
model TenantInvitation {
  id         String    @id @default(uuid())
  email      String
  role       UserRole  @default(AGENT)
  token      String    @unique
  expiresAt  DateTime
  acceptedAt DateTime?
  isActive   Boolean   @default(true)

  // Tenant relation
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Inviter
  invitedBy String // User ID who sent the invitation

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([token])
  @@index([email])
}

model User {
  id        String   @id @default(uuid())
  email     String
  password  String? // Hashed password (optional for Google OAuth users)
  name      String
  company   String   @default("")
  role      UserRole @default(AGENT)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relationship
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Google OAuth for Authentication (Profile Only)
  googleId         String? @unique
  googleEmail      String?
  googleProfilePic String?

  // Gmail Integration (Service-Specific Tokens)
  gmailAccessToken  String?
  gmailRefreshToken String?
  gmailTokenExpiry  DateTime?
  gmailConnectedAt  DateTime?
  gmailScopes       Json? // Array of granted scopes

  // Google Calendar Integration (Service-Specific Tokens)
  calendarAccessToken  String?
  calendarRefreshToken String?
  calendarTokenExpiry  DateTime?
  calendarConnectedAt  DateTime?
  calendarScopes       Json? // Array of granted scopes

  // Password Reset
  passwordResetToken   String?
  passwordResetExpires DateTime?

  // Team & Department
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  teamId       String?
  team         Team?       @relation(fields: [teamId], references: [id], onDelete: SetNull)

  // Relations
  leads                 Lead[]
  contacts              Contact[]
  invoices              Invoice[]
  deals                 Deal[]
  tasks                 Task[]
  whatsappConversations WhatsAppConversation[]
  calendarEvents        CalendarEvent[]
  activityLogs          ActivityLog[]
  sessions              Session[]
  emailLogs             EmailLog[]
  automationRules       AutomationRule[]
  documents             Document[]
  salesForecasts        SalesForecast[]
  revenueGoals          RevenueGoal[]
  vectorDataUploads     VectorDataUpload[]
  aiConversations       AIConversation[]
  campaigns             Campaign[]
  forms                 Form[]
  landingPages          LandingPage[]

  @@unique([email, tenantId])
  @@index([email])
  @@index([googleId])
  @@index([role])
  @@index([departmentId])
  @@index([teamId])
  @@index([tenantId])
}

model Department {
  id          String   @id @default(uuid())
  name        String
  description String?
  managerId   String? // Department manager
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Multi-tenant relationship
  tenantId String

  // Relations
  users User[]
  teams Team[]

  @@index([managerId])
  @@index([tenantId])
}

model Team {
  id           String      @id @default(uuid())
  name         String
  description  String?
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  managerId    String? // Team lead/manager
  isActive     Boolean     @default(true)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  // Multi-tenant relationship
  tenantId String

  // Relations
  users User[]

  @@index([departmentId])
  @@index([managerId])
  @@index([tenantId])
}

model ActivityLog {
  id          String   @id @default(uuid())
  action      String // 'CREATE' | 'UPDATE' | 'DELETE' | 'LOGIN' | 'LOGOUT' | 'VIEW' | etc.
  entityType  String // 'Lead' | 'Contact' | 'Invoice' | 'Deal' | 'Task' | 'User' | etc.
  entityId    String? // ID of the affected entity
  description String   @db.Text
  metadata    Json? // Additional data (before/after values, etc.)
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([entityType])
  @@index([action])
  @@index([createdAt])
}

model Session {
  id           String   @id @default(uuid())
  token        String   @unique
  refreshToken String?  @unique
  expiresAt    DateTime
  ipAddress    String?
  userAgent    String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model Lead {
  id              String    @id @default(uuid())
  name            String
  company         String
  email           String
  phone           String
  whatsapp        String?
  source          String // 'web-form' | 'whatsapp' | 'call' | 'email' | 'referral' | 'social-media' | 'missed-call'
  status          String // 'new' | 'contacted' | 'qualified' | 'proposal' | 'negotiation' | 'won' | 'lost'
  priority        String // 'low' | 'medium' | 'high' | 'urgent'
  estimatedValue  Float
  assignedTo      String
  createdBy       String? // User ID of who created this lead (for tracking ownership)
  notes           String    @default("")
  tags            String[] // Array of tags
  website         String?
  linkedIn        String?
  twitter         String?
  facebook        String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastContactedAt DateTime?
  nextFollowUpAt  DateTime?

  // Multi-tenant relationship
  tenantId String

  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Deal relation (auto-created when lead is created)
  dealId String? @unique
  deal   Deal?   @relation("LeadToDeal", fields: [dealId], references: [id], onDelete: SetNull)

  // Pipeline Stage relation (single source of truth)
  stageId       String
  pipelineStage PipelineStage @relation(fields: [stageId], references: [id], onDelete: Restrict)

  @@index([status, priority])
  @@index([assignedTo])
  @@index([userId])
  @@index([dealId])
  @@index([createdBy])
  @@index([tenantId])
  @@index([stageId])
}

model Contact {
  id             String   @id @default(uuid())
  name           String
  company        String
  designation    String
  email          String
  phone          String
  alternatePhone String?
  whatsapp       String?
  type           String // 'customer' | 'prospect' | 'partner' | 'vendor'
  industry       String // 'technology' | 'manufacturing' | 'retail' | 'export' | 'services' | 'textile' | 'food' | 'healthcare' | 'other'
  companySize    String
  gstNumber      String?
  panNumber      String?
  addressStreet  String   @default("")
  addressCity    String   @default("")
  addressState   String   @default("")
  addressPincode String   @default("")
  addressCountry String   @default("India")
  website        String?
  linkedIn       String?
  notes          String   @default("")
  tags           String[] // Array of tags
  assignedTo     String
  createdBy      String? // User ID of who created this contact
  lifetimeValue  Float    @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Multi-tenant relationship
  tenantId String

  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Deal relation (one-to-many)
  deals Deal[]

  @@index([type])
  @@index([assignedTo])
  @@index([userId])
  @@index([createdBy])
  @@index([tenantId])
}

model Invoice {
  id              String    @id @default(uuid())
  invoiceNumber   String    @unique
  customerName    String
  customerEmail   String
  customerPhone   String
  customerAddress String
  customerCity    String    @default("")
  customerState   String
  customerGST     String?
  companyName     String
  companyAddress  String
  companyCity     String    @default("")
  companyState    String
  companyGST      String
  companyPAN      String
  status          String // 'draft' | 'sent' | 'paid' | 'overdue' | 'cancelled'
  paymentMethod   String? // 'cash' | 'upi' | 'bank-transfer' | 'cheque' | 'card' | 'razorpay' | 'paytm'
  paymentDate     DateTime?
  dueDate         DateTime
  subtotal        Float
  totalDiscount   Float     @default(0)
  cgst            Float     @default(0)
  sgst            Float     @default(0)
  igst            Float     @default(0)
  totalTax        Float
  roundOff        Float     @default(0)
  total           Float
  notes           String    @default("")
  lineItems       Json // Store line items as JSON
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Multi-tenant relationship
  tenantId String

  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([customerName])
  @@index([userId])
  @@index([tenantId])
}

model PipelineStage {
  id              String    @id @default(uuid())
  name            String // 'New Lead', 'Qualified', 'Proposal', etc.
  slug            String // 'new-lead', 'qualified', 'proposal', etc.
  color           String    @default("blue") // Tailwind color class (e.g., 'blue', 'green', 'red')
  order           Int // Display order (1, 2, 3, etc.)
  isDefault       Boolean   @default(false) // True for backward compatibility
  isSystemDefault Boolean   @default(false) // True for the ONE default "New Lead" stage per tenant
  isActive        Boolean   @default(true) // Soft delete
  description     String? // Optional description for the stage
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Stage type: LEAD, DEAL, or BOTH
  stageType StageType @default(BOTH)

  // Stage mapping for conversion rate calculations
  isNewLeadStage Boolean @default(false) // Mark as default stage for new leads
  isWonStage     Boolean @default(false) // Mark as won/closed-won stage
  isLostStage    Boolean @default(false) // Mark as lost/closed-lost stage

  // Multi-tenant relationship (stages are tenant-level, not user-level)
  tenantId String

  // Relations: Leads and Deals using this stage
  leads Lead[]
  deals Deal[]

  @@unique([tenantId, slug]) // Each tenant can have only one stage with a specific slug
  @@index([tenantId])
  @@index([tenantId, stageType])
  @@index([order])
  @@index([isActive])
  @@index([isSystemDefault])
  @@index([isWonStage])
  @@index([isLostStage])
  @@index([isNewLeadStage])
}

model Deal {
  id                String   @id @default(uuid())
  title             String
  company           String
  contactName       String
  email             String // Synced with lead email
  phone             String   @default("") // Synced with lead phone
  contactId         String? // Optional link to Contact
  value             Float
  stage             String // DEPRECATED: Use stageId instead (kept for backward compatibility)
  stageId           String // Direct reference to PipelineStage (single source of truth)
  probability       Int // 0-100
  expectedCloseDate DateTime
  assignedTo        String
  createdBy         String? // User ID of who created this deal (auto from lead)
  notes             String   @default("")
  tags              String[]
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Multi-tenant relationship
  tenantId String

  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Contact relation (optional)
  contact Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)

  // Pipeline stage relation (single source of truth)
  pipelineStage PipelineStage @relation(fields: [stageId], references: [id], onDelete: Restrict)

  // Lead relation (backref from Lead)
  lead Lead? @relation("LeadToDeal")

  @@index([stage])
  @@index([stageId])
  @@index([assignedTo])
  @@index([userId])
  @@index([contactId])
  @@index([createdBy])
  @@index([tenantId])
}

model Task {
  id          String    @id @default(uuid())
  title       String
  description String    @default("")
  priority    String // 'low' | 'medium' | 'high' | 'urgent'
  status      String // 'todo' | 'in-progress' | 'completed'
  dueDate     DateTime
  assignedTo  String // Changed from 'assignee' to match other models
  createdBy   String? // User ID of who created this task
  tags        String[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  // Multi-tenant relationship
  tenantId String

  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([assignedTo])
  @@index([userId])
  @@index([createdBy])
  @@index([tenantId])
}

model WhatsAppConversation {
  id            String    @id @default(uuid())
  contactName   String
  contactPhone  String // WhatsApp number with country code
  contactId     String? // Reference to Contact if exists
  lastMessage   String?   @db.Text
  lastMessageAt DateTime?
  unreadCount   Int       @default(0)
  filePath      String // Path to conversation file (e.g., "conversations/user123/+919876543210.json")
  aiEnabled     Boolean   @default(true) // AI assistant enabled for this conversation

  // Conversation memory management
  summary      String? @db.Text // Compressed summary of old messages
  messageCount Int     @default(0) // Total message count

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relationship
  tenantId String

  // User relation - who owns this conversation
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relations
  messages WhatsAppMessage[]

  @@unique([userId, contactPhone])
  @@index([userId])
  @@index([contactPhone])
  @@index([lastMessageAt])
  @@index([tenantId])
}

model WhatsAppMessage {
  id            String   @id @default(uuid())
  message       String   @db.Text
  sender        String // 'user' | 'contact' | 'ai'
  senderName    String // Name of who sent the message
  status        String   @default("sent") // 'sent' | 'delivered' | 'read' | 'failed'
  messageType   String   @default("text") // 'text' | 'image' | 'document' | 'template'
  isAiGenerated Boolean  @default(false) // True if message was generated by AI
  metadata      Json? // Additional data (messageId from WhatsApp, etc.)
  createdAt     DateTime @default(now())

  // Multi-tenant relationship
  tenantId String

  // Conversation relation
  conversationId String
  conversation   WhatsAppConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
  @@index([tenantId])
}

model CalendarEvent {
  id            String   @id @default(uuid())
  title         String
  description   String?  @db.Text
  startTime     DateTime
  endTime       DateTime
  location      String?
  attendees     String[] // Array of email addresses
  googleEventId String? // Google Calendar event ID
  isAllDay      Boolean  @default(false)
  color         String   @default("blue") // Event color for UI
  reminders     Json? // Reminder settings
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Multi-tenant relationship
  tenantId String

  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([startTime])
  @@index([googleEventId])
  @@index([tenantId])
}

model EmailLog {
  id             String    @id @default(uuid())
  to             String[] // Array of recipient email addresses
  cc             String[]  @default([])
  bcc            String[]  @default([])
  from           String // Sender email
  subject        String
  body           String    @db.Text
  htmlBody       String?   @db.Text
  status         String // 'sent' | 'failed' | 'pending' | 'queued'
  errorMessage   String?   @db.Text
  messageId      String? // Email provider message ID
  gmailMessageId String? // Gmail API message ID
  gmailThreadId  String? // Gmail thread ID for grouping replies
  entityType     String? // 'Lead' | 'Contact' | 'Deal' | 'PasswordReset' | 'Manual'
  entityId       String? // ID of related entity
  attachments    Json? // Array of attachment metadata
  sentAt         DateTime?
  openedAt       DateTime?
  clickedAt      DateTime?
  replyCount     Int       @default(0) // Number of replies received
  lastReplyAt    DateTime? // When last reply was received
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Multi-tenant relationship
  tenantId String

  // User relation - who sent the email
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Reply relation
  parentEmailId String? // If this is a reply, reference to parent email
  parentEmail   EmailLog?  @relation("EmailReplies", fields: [parentEmailId], references: [id], onDelete: SetNull)
  replies       EmailLog[] @relation("EmailReplies")

  @@index([userId])
  @@index([status])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@index([to])
  @@index([gmailThreadId])
  @@index([parentEmailId])
  @@index([tenantId])
}

model AutomationRule {
  id        String  @id @default(uuid())
  name      String // Rule name (e.g., "Lead Created Email", "Stage Change Notification")
  type      String // 'lead_created' | 'stage_change' | 'custom'
  isEnabled Boolean @default(true)

  // Trigger configuration
  triggerEvent      String // 'lead.created' | 'lead.stage_changed' | 'deal.stage_changed'
  triggerConditions Json? // Additional conditions (e.g., {fromStage: 'new', toStage: 'contacted'})

  // Action configuration
  actionType   String // 'send_email' | 'send_whatsapp' | 'send_both' | 'create_task' | 'assign_lead' | 'webhook'
  actionConfig Json // Email template, task details, etc.

  // Email template for email actions
  emailSubject  String?
  emailTemplate String? @db.Text

  // WhatsApp template for WhatsApp actions
  whatsappMessage  String? @db.Text // WhatsApp message template
  whatsappTemplate String? // WhatsApp Business template name (optional)

  // Stage change specific config
  fromStage  String? // Source stage for stage change triggers
  toStage    String? // Destination stage for stage change triggers
  entityType String  @default("lead") // 'lead' | 'deal' - which entity the automation applies to

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relationship
  tenantId String

  // User relation - who created this rule
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([isEnabled])
  @@index([triggerEvent])
  @@index([tenantId])
}

model Document {
  id       String @id @default(uuid())
  fileName String // Original file name
  fileSize Int // Size in bytes
  mimeType String // File MIME type
  filePath String // Relative path to stored file

  // Entity association
  entityType String // 'Lead' | 'Contact' | 'Deal' | 'Task'
  entityId   String // ID of the associated entity

  // Metadata
  description String?  @db.Text
  uploadedBy  String // User who uploaded
  tags        String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relationship
  tenantId String

  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([entityType, entityId])
  @@index([uploadedBy])
  @@index([createdAt])
  @@index([tenantId])
}

model SalesForecast {
  id             String   @id @default(uuid())
  forecastDate   DateTime // Date for this forecast period
  forecastPeriod String // 'daily' | 'weekly' | 'monthly' | 'quarterly' | 'yearly'

  // Forecast metrics
  expectedRevenue Float @default(0)
  pipelineValue   Float @default(0)
  weightedValue   Float @default(0) // Pipeline value weighted by probability
  leadCount       Int   @default(0)
  dealCount       Int   @default(0)
  wonCount        Int   @default(0)
  lostCount       Int   @default(0)
  conversionRate  Float @default(0) // Percentage

  // Breakdown by stage
  stageBreakdown Json? // {stage: {count, value, probability}}

  // Breakdown by user/team
  userBreakdown Json? // {userId: {revenue, deals, leads}}

  // Historical comparison
  previousPeriodRevenue Float? @default(0)
  growthRate            Float? @default(0) // Percentage growth

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relationship
  tenantId String

  // User/organization relation (null for org-wide forecasts)
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([forecastDate])
  @@index([forecastPeriod])
  @@index([tenantId])
}

model VectorDataUpload {
  id               String  @id @default(uuid())
  fileName         String // Original file name
  fileSize         Int // Size in bytes
  filePath         String // Path to stored file
  status           String // 'pending' | 'processing' | 'completed' | 'failed'
  recordsProcessed Int     @default(0)
  errorMessage     String? @db.Text

  uploadedBy  String // User who uploaded
  processedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Multi-tenant relationship
  tenantId String

  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([tenantId])
}

// Revenue Goal Model - Track sales targets and goals
model RevenueGoal {
  id            String   @id @default(uuid())
  userId        String? // Null for organization-wide goals
  period        String // 'monthly' | 'quarterly' | 'yearly'
  targetRevenue Float // Goal amount
  startDate     DateTime // Goal period start
  endDate       DateTime // Goal period end
  description   String?  @db.Text
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Multi-tenant relationship
  tenantId String

  // User relation (optional for org-wide goals)
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([period])
  @@index([startDate, endDate])
  @@index([tenantId])
}

// AI Conversation Model - Portal AI conversation memory
model AIConversation {
  id String @id @default(uuid())

  // Multi-tenant relationship
  tenantId String

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Conversation summary (compressed memory)
  summary String? @db.Text

  // Metadata
  messageCount  Int      @default(0)
  lastMessageAt DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Messages (recent only)
  messages AIMessage[]

  @@index([userId])
  @@index([lastMessageAt])
  @@index([tenantId])
}

// AI Message Model - Individual messages in conversation
model AIMessage {
  id String @id @default(uuid())

  // Multi-tenant relationship
  tenantId String

  conversationId String
  conversation   AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  role    String // 'user' | 'assistant'
  content String @db.Text

  // Function call metadata (if AI used tools)
  functionCalls Json? // Array of function calls made

  createdAt DateTime @default(now())

  @@index([conversationId])
  @@index([createdAt])
  @@index([tenantId])
}

// Campaign Model - Main campaign configuration for email and WhatsApp automation
model Campaign {
  id          String  @id @default(uuid())
  name        String // Campaign name
  description String? @db.Text
  channel     String // 'email' | 'whatsapp'
  status      String  @default("draft") // 'draft' | 'scheduled' | 'running' | 'completed' | 'paused' | 'failed'

  // Content
  subject     String? // For emails only
  htmlContent String? @db.Text // Custom HTML for emails
  textContent String  @db.Text // Message content (plain text for WhatsApp, fallback for email)

  // WhatsApp-specific content (for media and template messages)
  whatsappMessageType     String? // 'text' | 'media' | 'template'
  whatsappMediaType       String? // 'image' | 'document' | 'video' | 'audio'
  whatsappMediaUrl        String? // URL to media file
  whatsappCaption         String? @db.Text // Caption for media messages
  whatsappTemplateName    String? // Template name for template messages
  whatsappTemplateLanguage String? // Template language code (e.g., 'en', 'es')
  whatsappTemplateParams  Json? // Array of template parameters

  // Scheduling
  scheduledAt DateTime? // When to send (null for immediate)
  completedAt DateTime?

  // Target audience configuration
  targetType    String // 'all' | 'leads' | 'contacts' | 'custom' | 'tags' | 'stage'
  targetFilters Json? // Store filter criteria as JSON

  // Statistics
  totalRecipients Int @default(0)
  sentCount       Int @default(0)
  failedCount     Int @default(0)
  deliveredCount  Int @default(0) // For WhatsApp
  openedCount     Int @default(0) // For emails (if tracking enabled)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relationship
  tenantId String

  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relations
  recipients CampaignRecipient[]
  logs       CampaignLog[]

  @@index([userId])
  @@index([status])
  @@index([scheduledAt])
  @@index([channel])
  @@index([tenantId])
}

// Campaign Recipient - Individual recipient tracking
model CampaignRecipient {
  id String @id @default(uuid())

  // Multi-tenant relationship
  tenantId String

  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  // Recipient details
  recipientType  String // 'lead' | 'contact'
  recipientId    String // ID of lead or contact
  recipientName  String
  recipientEmail String? // For email campaigns
  recipientPhone String? // For WhatsApp campaigns

  // Delivery status
  status       String    @default("pending") // 'pending' | 'sent' | 'failed' | 'delivered' | 'opened'
  sentAt       DateTime?
  deliveredAt  DateTime?
  openedAt     DateTime?
  failedAt     DateTime?
  errorMessage String?   @db.Text

  // External IDs
  messageId String? // Email/WhatsApp message ID

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([campaignId])
  @@index([status])
  @@index([recipientType, recipientId])
  @@index([tenantId])
}

// Campaign Log - Audit trail
model CampaignLog {
  id String @id @default(uuid())

  // Multi-tenant relationship
  tenantId String

  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  action   String // 'created' | 'scheduled' | 'started' | 'paused' | 'resumed' | 'completed' | 'failed'
  message  String @db.Text
  metadata Json? // Additional context

  createdAt DateTime @default(now())

  @@index([campaignId])
  @@index([createdAt])
  @@index([tenantId])
}

// Form Model - Embeddable lead capture forms
model Form {
  id          String  @id @default(uuid())
  name        String // Form name (internal use)
  slug        String  @unique // URL-friendly identifier for embedding
  title       String // Form heading shown to users
  description String? @db.Text // Subtitle or description

  // Form fields configuration
  fields Json // Array of field definitions (name, email, phone, custom fields)

  // Styling & branding
  primaryColor   String @default("#3b82f6") // Brand color
  buttonText     String @default("Submit")
  successMessage String @default("Thank you! We'll be in touch soon.")

  // Behavior
  redirectUrl       String? // Optional redirect after submission
  notificationEmail String? // Email to notify on new submission
  autoAssignTo      String? // Auto-assign leads to specific user

  // Settings
  isActive     Boolean @default(true)
  requireEmail Boolean @default(true)
  requirePhone Boolean @default(false)

  // Tracking
  viewCount       Int @default(0)
  submissionCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relationship
  tenantId String

  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relations
  submissions  FormSubmission[]
  landingPages LandingPage[]

  @@index([userId])
  @@index([slug])
  @@index([isActive])
  @@index([tenantId])
}

// Form Submission Model - Captured leads from forms
model FormSubmission {
  id String @id @default(uuid())

  // Multi-tenant relationship
  tenantId String

  formId String
  form   Form   @relation(fields: [formId], references: [id], onDelete: Cascade)

  // Submission data
  data Json // All form field values

  // Lead information (extracted from data)
  name    String?
  email   String?
  phone   String?
  company String?

  // Source tracking
  ipAddress   String?
  userAgent   String?
  referrer    String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?

  // Lead creation
  leadId String? @unique // Created lead ID
  status String  @default("new") // 'new' | 'converted' | 'spam'

  createdAt DateTime @default(now())

  @@index([formId])
  @@index([status])
  @@index([createdAt])
  @@index([leadId])
  @@index([tenantId])
}

// Landing Page Model - AI-powered landing pages
model LandingPage {
  id   String @id @default(uuid())
  name String // Page name (internal)
  slug String @unique // URL-friendly identifier

  // SEO
  title           String // Page title (SEO)
  metaDescription String? @db.Text

  // Content blocks (JSON structure for each component)
  content Json // {header, hero, about, services, testimonials, etc.}

  // Styling
  theme Json // Color scheme, fonts, spacing

  // Code snippets
  headScripts String? @db.Text // Google Analytics, Meta Pixel, etc.
  bodyScripts String? @db.Text // Additional tracking scripts

  // Form integration
  formId String?
  form   Form?   @relation(fields: [formId], references: [id], onDelete: SetNull)

  // Settings
  isPublished  Boolean @default(false)
  customDomain String? // Optional custom domain

  // Tracking
  viewCount Int @default(0)

  // AI editing history
  aiPrompts Json? // Array of AI prompts used for editing

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  // Multi-tenant relationship
  tenantId String

  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([slug])
  @@index([isPublished])
  @@index([tenantId])
}
